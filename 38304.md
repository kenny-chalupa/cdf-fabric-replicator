# 38304- Delta Lake Upserts

For this spike we set out to investigate how to write to lake house and avoid duplicate data being written to the lakehouse should a failure occour. 

Four scenarios were investigated:

1) append mode, with state store tracking last_created_time(Existing Solution)

2) append mode. no state store, quering last_created_time from the lakehouse

3) merge/upsert, with state store tracking last_created_time 

4) merge/upsert, no state store, quering last_created_time from the lakehouse

## Merge/upsert, with state store tracking last_created_time

Delta-rs support merge/upsert natively. Delta-rs uses the merge method to upsert data. The merge must have a predicate to find matches for upsert. The following code was used in events

```python
data = pa.Table.from_pylist(events)
        dt = DeltaTable(abfss_path, storage_options={"bearer_token": token.token, "user_fabric_endpoint":"true"})

        (
        dt.merge(
            source=data,
            predicate="s.id = t.id",
            source_alias="s",
            target_alias="t",
        )
        .when_matched_update_all()
        .when_not_matched_insert_all()
        .execute()
        )
```

## Findings

### Quering last_created_time from the lakehouse

Directly quering the last created time directly from the lakehouse is not supported with Delta-Rs and PyArrow. It would require the additional libraries such as Dask. Due to the complexity, scenarios 2 and 4 were not measured and tested.

### Test Evaluation

For evaluating scenarios 1 and 3, the existing test_event_replicator integration test was used. Each call the replicators `.process_events()` was timed. Each senario was ran with 5000 tests for 10 iterations.

#### Results

|         | Append(seconds) | Merge(seconds) |
| ------- | --------------- | -------------- |
|         | 366.0111        | 365.0265       |
|         | 394.1287        | 343.9028       |
|         | 427.908         | 357.7286       |
|         | 458.63          | 381.3495       |
|         | 459.6185        | 378.7158       |
|         | 493.4069        | 402.0099       |
|         | 409.0909        | 474.7517       |
|         | 428.2145        | 419.1865       |
|         | 408.2482        | 459.9641       |
|         | 432.3558        | 510.2248       |
| Average | 427.7612        | 409.286        |